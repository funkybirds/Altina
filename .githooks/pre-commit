#!/usr/bin/env bash
# Pre-commit hook (bash)
# Formats staged C/C++ files with clang-format and re-adds them to the index.

set -euo pipefail

if ! command -v clang-format >/dev/null 2>&1; then
  echo "ERROR: clang-format not found in PATH. Install it or add to PATH." >&2
  exit 1
fi

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | tr -d '\r')
if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

FILE_LIST=""
for f in $STAGED_FILES; do
  case "$f" in
    *.c|*.cc|*.cpp|*.cxx|*.h|*.hh|*.hpp|*.hxx|*.ipp|*.inl)
      if [ -f "$f" ]; then
        FILE_LIST="$FILE_LIST $f"
      fi
      ;;
    *)
      ;;
  esac
done

if [ -z "$FILE_LIST" ]; then
  exit 0
fi

echo "clang-format: formatting staged files..."
clang-format -i $FILE_LIST
git add $FILE_LIST

exit 0
